<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿ç”¢ x ä¿éšªé›²ç«¯ CRM (V23 å¤šé‡èº«ä»½ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' } } } }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", "PingFang TC", sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* æ™‚é–“è»¸ */
        .timeline-item { padding-left: 24px; position: relative; }
        .timeline-item::before {
            content: ''; position: absolute; left: 6px; top: 24px; bottom: -24px; width: 2px; background-color: #e5e7eb;
        }
        .dark .timeline-item::before { background-color: #374151; }
        .timeline-item:last-child::before { display: none; }
        .timeline-dot {
            position: absolute; left: 0; top: 6px; width: 14px; height: 14px;
            border-radius: 50%; border: 2px solid #fff; z-index: 10;
        }
        .dark .timeline-dot { border-color: #1f2937; }
        .timeline-item.latest .timeline-dot { background-color: #4f46e5; width: 16px; height: 16px; left: -1px;}

        /* å‹•ç•« */
        @keyframes slide-up { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .toast-enter { animation: slide-up 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-dark-900 dark:text-gray-100 transition-colors duration-300 pb-24">

    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // â–¼â–¼â–¼ æ‚¨çš„å°ˆå±¬é›²ç«¯é‡‘é‘° (Tse-Lung Hsu) â–¼â–¼â–¼
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDc82jnv2QcnlsStzR9qoQl_EOe070Ok7s",
            authDomain: "tse-lung-hsu.firebaseapp.com",
            projectId: "tse-lung-hsu",
            storageBucket: "tse-lung-hsu.firebasestorage.app",
            messagingSenderId: "772427548884",
            appId: "1:772427548884:web:9dbb92f460bc974fdd9341",
            measurementId: "G-BL7E10WV83"
        };
        // ==========================================

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const { useState, useEffect, useMemo, useRef } = React;

        // --- åœ–æ¨™é›† ---
        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>,
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>,
            Close: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" /></svg>,
            Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>,
            Note: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>,
            Briefcase: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
            Heart: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>,
            Money: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4M12 4v12m0-12l3 3m-3-3l-3 3" /></svg>,
            Phone: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
            Cake: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M21 15.546c-.523 0-1.046.151-1.5.454a2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.701 2.701 0 00-1.5-.454M9 6v2m3-2v2m3-2v2M9 3h.01M12 3h.01M15 3h.01M21 21v-7a2 2 0 00-2-2H5a2 2 0 00-2 2v7h18zm-3-9v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2h12z" /></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            Sort: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg>,
            Excel: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            Moon: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
            Sun: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Building: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path strokeLinecap="round" strokeLinejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
            Line: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22 10.8c0-4.8-5.3-8.8-12-8.8S-2 6 -2 10.8c0 4.2 3.8 7.8 9.2 8.6.4.1.9.3 1 .8 0 0 .2 1.3.1 1.6-.1.6-.4 2.1 1.9.9s10.8-6.3 10.8-6.3c2.4-1.8 3-3.7 3-5.6z"/></svg>,
            Facebook: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg>,
            Instagram: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>,
            Pin: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5v6l1 1 1-1v-6h5v-2l-2-2z"/></svg>,
            PinOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M16 12V4h1V2H7v2h1v8l-2 2v2h5v6l1 1 1-1v-6h5v-2l-2-2z M2 2l20 20"/></svg>,
            ChartBar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7"/></svg>,
            Bed: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>,
            Car: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M5 10v10M19 10v10"/></svg>,
            Gift: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg>,
            Fire: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24" className="text-red-500"><path strokeLinecap="round" strokeLinejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" /><path strokeLinecap="round" strokeLinejoin="round" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z" /></svg>,
            Card: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>,
            GoogleCal: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-blue-500"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        };

        const MemoWidget = ({ db }) => {
            const [memos, setMemos] = useState([]);
            const [input, setInput] = useState('');
            const [editId, setEditId] = useState(null);
            const [editInput, setEditInput] = useState('');

            useEffect(() => {
                const unsub = db.collection('memos').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    setMemos(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, [db]);

            const add = async (e) => { e.preventDefault(); if(!input.trim()) return; await db.collection('memos').add({ content: input, createdAt: Date.now() }); setInput(''); };
            const del = async (id) => { if(confirm('åˆªé™¤?')) await db.collection('memos').doc(id).delete(); };
            const startEdit = (m) => { setEditId(m.id); setEditInput(m.content); };
            const saveEdit = async (id) => { await db.collection('memos').doc(id).update({ content: editInput }); setEditId(null); };

            return (
                <div className="bg-white dark:bg-dark-800 p-4 rounded-xl shadow-sm border border-orange-100 dark:border-dark-700 relative overflow-hidden flex flex-col h-40">
                    <div className="flex justify-between items-center mb-2"><span className="text-orange-500 text-xs font-bold uppercase flex items-center"><Icons.Note/> å‚™å¿˜éŒ„</span><span className="text-xs text-gray-400">{memos.length} å‰‡</span></div>
                    <div className="flex-grow overflow-y-auto no-scrollbar space-y-1">
                        {memos.map(m => (
                            <div key={m.id} className="group flex items-center justify-between text-sm text-gray-600 dark:text-gray-300 bg-orange-50 dark:bg-dark-700/50 p-1.5 rounded">
                                {editId === m.id ? (
                                    <div className="flex w-full gap-1"><input className="w-full text-xs bg-white dark:bg-dark-900 rounded border px-1" value={editInput} onChange={e=>setEditInput(e.target.value)} /><button onClick={()=>saveEdit(m.id)} className="text-green-600"><Icons.Check/></button></div>
                                ) : (
                                    <><span className="truncate w-full">{m.content}</span><div className="hidden group-hover:flex gap-1"><button onClick={()=>startEdit(m)} className="text-blue-500"><Icons.Edit/></button><button onClick={()=>del(m.id)} className="text-red-500"><Icons.Trash/></button></div></>
                                )}
                            </div>
                        ))}
                    </div>
                    <form onSubmit={add} className="mt-2 flex gap-1"><input className="w-full text-xs border rounded px-2 py-1 dark:bg-dark-900 dark:border-dark-600" placeholder="æ–°å¢äº‹é …..." value={input} onChange={e=>setInput(e.target.value)} /><button type="submit" className="text-orange-500 hover:text-orange-600"><Icons.Plus/></button></form>
                </div>
            );
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            const bgClass = type === 'success' ? 'bg-indigo-600 dark:bg-indigo-500' : 'bg-red-500 dark:bg-red-600';
            return (
                <div className={`fixed bottom-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full text-white shadow-xl flex items-center gap-3 z-[100] toast-enter ${bgClass}`}>
                    <span className="text-lg">{type === 'success' ? 'ğŸ‘Œ' : 'âš ï¸'}</span><span className="font-bold tracking-wide">{message}</span>
                </div>
            );
        };

        const getLocalISOString = (ts) => { const d = ts ? new Date(ts) : new Date(); return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16); };
        
        const timeAgo = (date) => {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " å¹´å‰";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " å€‹æœˆå‰";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " å¤©å‰";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " å°æ™‚å‰";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " åˆ†é˜å‰";
            return "å‰›å‰›";
        };

        const getZodiac = (dateStr) => {
            if(!dateStr) return '';
            const d = new Date(dateStr);
            const month = d.getMonth() + 1;
            const day = d.getDate();
            const zodiacs = ['é­”ç¾¯','æ°´ç“¶','é›™é­š','ç‰¡ç¾Š','é‡‘ç‰›','é›™å­','å·¨èŸ¹','ç…å­','è™•å¥³','å¤©ç§¤','å¤©è ','å°„æ‰‹'];
            const dates = [20,19,20,20,21,21,22,23,23,23,22,21];
            let idx = month - 1;
            if (day < dates[idx]) idx = (idx === 0 ? 11 : idx - 1);
            return zodiacs[idx] + 'åº§';
        };

        const getAge = (dateStr) => {
            if(!dateStr) return '';
            const today = new Date();
            const birthDate = new Date(dateStr);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        };

        const getDaysUntilBirthday = (dateStr) => {
            if(!dateStr) return null;
            const today = new Date();
            const bday = new Date(dateStr);
            bday.setFullYear(today.getFullYear());
            if (bday < today) bday.setFullYear(today.getFullYear() + 1);
            const diff = Math.ceil((bday - today) / (1000 * 60 * 60 * 24));
            return diff;
        };

        const addToGoogleCalendar = (client) => {
            if (!client.nextContactDate) return;
            const start = new Date(client.nextContactDate);
            const end = new Date(start.getTime() + 60 * 60 * 1000); 
            const format = (d) => d.toISOString().replace(/-|:|\.\d\d\d/g, "");
            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=è¯çµ¡${encodeURIComponent(client.name)}&details=é›»è©±:${client.phone||'ç„¡'}&dates=${format(start)}/${format(end)}`;
            window.open(url, '_blank');
        };

        const calculateLeadScore = (client) => {
            let score = 0;
            if (client.status === 'å·²æˆäº¤') return 100;
            if (client.status === 'è·Ÿé€²ä¸­') score += 40;
            if (client.status === 'è€ƒæ…®ä¸­') score += 20;
            if (client.lineId || client.phone) score += 10;
            if (client.homeAddress || client.companyAddress) score += 10;
            if (client.income) score += 10;
            if (client.lastContactAt) {
                const days = (Date.now() - client.lastContactAt) / (1000 * 60 * 60 * 24);
                if (days < 3) score += 30; else if (days < 7) score += 20; else if (days < 30) score += 10;
            }
            return Math.min(score, 100);
        };

        const App = () => {
            const [clients, setClients] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isLogModalOpen, setIsLogModalOpen] = useState(false);
            const [currentClient, setCurrentClient] = useState(null);
            const [toast, setToast] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            const [expandedCardId, setExpandedCardId] = useState(null); 

            // Log States
            const [editingLogTimestamp, setEditingLogTimestamp] = useState(null);
            const [tempLogContent, setTempLogContent] = useState('');
            const [tempLogDate, setTempLogDate] = useState(''); 
            const [newLogContent, setNewLogContent] = useState('');
            const [newLogDate, setNewLogDate] = useState(''); 
            const [nextContactDate, setNextContactDate] = useState(''); 

            // Edit Client States
            const [isEditMode, setIsEditMode] = useState(false);
            const [editId, setEditId] = useState(null);

            // Filter States
            const [activeTab, setActiveTab] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [filterRegion, setFilterRegion] = useState('All');
            const [filterGender, setFilterGender] = useState('All');
            const [filterAge, setFilterAge] = useState('All');
            const [sortBy, setSortBy] = useState('updated'); 
            const [quickFilter, setQuickFilter] = useState('All'); 
            const [filterReType, setFilterReType] = useState('All');

            const fileInputRef = useRef(null);

            const [formData, setFormData] = useState({
                name: '', phone: '', tags: '', status: 'æ–°å®¢æˆ¶', gender: 'ç”·', age: '', region: '', birthday: '',
                occupation: '', income: '', maritalStatus: 'æœªå©š', 
                homeAddress: '', companyAddress: '',
                lineId: '', facebook: '', instagram: '',
                isRealEstate: false, reBudget: '', reRequirements: '', reType: 'å¤§æ¨“', reUsage: 'è‡ªä½', reRoom: '', reParking: 'éœ€è¦', reAge: '',
                isInsurance: false, insBudget: '', insNeeds: '',
                insProducts: [],
                insuranceCategories: [], // V23 Multi-select
                referrals: '' 
            });

            const showToast = (message, type = 'success') => setToast({ message, type });

            // Dark Mode
            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            useEffect(() => {
                const unsubscribe = db.collection('clients').onSnapshot(snap => {
                    setClients(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, err => { console.error(err); showToast("é€£ç·šéŒ¯èª¤", "error"); setLoading(false); });
                return () => unsubscribe();
            }, []);

            // Stats
            const stats = useMemo(() => {
                const now = new Date();
                const total = clients.length;
                const upcomingBirthdays = clients.filter(c => c.birthday && (new Date(c.birthday).getMonth() === now.getMonth())).length;
                const todoToday = clients.filter(c => c.nextContactDate && new Date(c.nextContactDate).toISOString().slice(0,10) <= now.toISOString().slice(0, 10)).length;
                const following = clients.filter(c => c.status === 'è·Ÿé€²ä¸­').length;
                
                let pipelineValue = 0;
                clients.forEach(c => {
                    if (c.status === 'è·Ÿé€²ä¸­' || c.status === 'è€ƒæ…®ä¸­') {
                        if (c.realEstateData?.budget) pipelineValue += parseInt(c.realEstateData.budget) || 0;
                        if (c.insuranceData?.budget) pipelineValue += parseInt(c.insuranceData.budget) || 0;
                    }
                });

                return { total, upcomingBirthdays, todoToday, following, pipelineValue };
            }, [clients]);

            // All Tags for Cloud
            const allTags = useMemo(() => {
                const tags = new Set();
                clients.forEach(c => c.tags?.forEach(t => tags.add(t)));
                return Array.from(tags).slice(0, 8); 
            }, [clients]);

            // CRUD Clients
            const openAddModal = () => {
                setIsEditMode(false); setEditId(null);
                setFormData({ 
                    name: '', phone: '', tags: '', status: 'æ–°å®¢æˆ¶', gender: 'ç”·', age: '', region: '', birthday: '', 
                    occupation: '', income: '', maritalStatus: 'æœªå©š', 
                    homeAddress: '', companyAddress: '', lineId: '', facebook: '', instagram: '',
                    isRealEstate: false, reBudget: '', reRequirements: '', reType: 'å¤§æ¨“', reUsage: 'è‡ªä½', reRoom: '', reParking: 'éœ€è¦', reAge: '',
                    isInsurance: false, insuranceCategories: [], insBudget: '', insNeeds: '', insProducts: [],
                    referrals: '' 
                });
                setIsModalOpen(true);
            };

            const openEditModal = (c) => {
                setIsEditMode(true); setEditId(c.id);
                const tags = c.tags ? c.tags.join(' ') : '';
                const r = c.realEstateData || {}; const i = c.insuranceData || {};
                
                // Legacy support for single category -> array
                let cats = i.categories || [];
                if (cats.length === 0 && i.category) cats = [i.category];

                setFormData({
                    name: c.name||'', phone: c.phone||'', tags, status: c.status||'æ–°å®¢æˆ¶', gender: c.gender||'ç”·', age: c.age||'', region: c.region||'', birthday: c.birthday||'',
                    occupation: c.occupation||'', income: c.income||'', maritalStatus: c.maritalStatus||'æœªå©š',
                    homeAddress: c.homeAddress||'', companyAddress: c.companyAddress||'',
                    lineId: c.lineId||'', facebook: c.facebook||'', instagram: c.instagram||'',
                    isRealEstate: !!c.types.realEstate, 
                    reBudget: r.budget||'', reRequirements: r.requirements?r.requirements.join(' '):'', reType: r.type || 'å¤§æ¨“', 
                    reUsage: r.usage || 'è‡ªä½', reRoom: r.room || '', reParking: r.parking || 'éœ€è¦', reAge: r.age || '',
                    isInsurance: !!c.types.insurance, insuranceCategories: cats, insBudget: i.budget||'', insNeeds: i.needs?i.needs.join(' '):'',
                    insProducts: i.products || [],
                    referrals: c.referrals || ''
                });
                setIsModalOpen(true);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.name || (!formData.isRealEstate && !formData.isInsurance)) { showToast("è«‹å¡«å¯«å§“åä¸¦é¸æ“‡éœ€æ±‚", "error"); return; }
                try {
                    const processTags = (str) => str ? str.split(/[,ï¼Œ ]+/).filter(t => t.trim() !== '') : [];
                    const data = {
                        name: formData.name, phone: formData.phone, tags: processTags(formData.tags), status: formData.status, gender: formData.gender, age: formData.age, region: formData.region, birthday: formData.birthday,
                        occupation: formData.occupation, income: formData.income, maritalStatus: formData.maritalStatus,
                        homeAddress: formData.homeAddress, companyAddress: formData.companyAddress,
                        lineId: formData.lineId, facebook: formData.facebook, instagram: formData.instagram,
                        referrals: formData.referrals,
                        types: { realEstate: formData.isRealEstate, insurance: formData.isInsurance },
                        realEstateData: formData.isRealEstate ? { 
                            region: formData.region, budget: formData.reBudget, requirements: processTags(formData.reRequirements), 
                            type: formData.reType, usage: formData.reUsage, room: formData.reRoom, parking: formData.reParking, age: formData.reAge 
                        } : null,
                        insuranceData: formData.isInsurance ? { categories: formData.insuranceCategories, age: formData.age, budget: formData.insBudget, needs: processTags(formData.insNeeds), products: formData.insProducts } : null
                    };
                    if (isEditMode && editId) { await db.collection('clients').doc(editId).update(data); showToast("æ›´æ–°æˆåŠŸ"); }
                    else { await db.collection('clients').add({ ...data, createdAt: Date.now(), logs: [], isPinned: false }); showToast("æ–°å¢æˆåŠŸ"); }
                    setIsModalOpen(false);
                } catch (error) { showToast("å„²å­˜å¤±æ•—", "error"); }
            };

            const openLogModal = (c) => {
                setCurrentClient(c); setNewLogContent(''); setNewLogDate(getLocalISOString());
                setNextContactDate(c.nextContactDate ? getLocalISOString(c.nextContactDate) : ''); 
                setEditingLogTimestamp(null); setIsLogModalOpen(true);
            };

            const handleAddLog = async (e) => {
                e.preventDefault();
                const ts = newLogDate ? new Date(newLogDate).getTime() : Date.now();
                const nextTs = nextContactDate ? new Date(nextContactDate).getTime() : null;
                const newLog = { content: newLogContent, timestamp: ts };
                try {
                    const updateData = { lastContactAt: ts };
                    if (newLogContent.trim()) updateData.logs = firebase.firestore.FieldValue.arrayUnion(newLog);
                    if (nextTs) updateData.nextContactDate = nextTs;
                    await db.collection('clients').doc(currentClient.id).update(updateData);
                    setCurrentClient(p => ({
                        ...p, logs: newLogContent.trim() ? [...(p.logs||[]), newLog] : p.logs, lastContactAt: ts, nextContactDate: nextTs
                    }));
                    setNewLogContent(''); showToast("æ›´æ–°æˆåŠŸ");
                } catch (error) { showToast("æ›´æ–°å¤±æ•—", "error"); }
            };

            const saveEditLog = async () => {
                if(!tempLogContent.trim()) return;
                try {
                    const newTs = new Date(tempLogDate).getTime();
                    const newLogs = currentClient.logs.filter(l => l.timestamp !== editingLogTimestamp).concat({ content: tempLogContent, timestamp: newTs });
                    const newLast = Math.max(...newLogs.map(l => l.timestamp));
                    await db.collection('clients').doc(currentClient.id).update({ logs: newLogs, lastContactAt: newLast });
                    setCurrentClient(p => ({ ...p, logs: newLogs, lastContactAt: newLast }));
                    setEditingLogTimestamp(null); showToast("ç´€éŒ„å·²ä¿®æ­£");
                } catch (error) { showToast("æ›´æ–°å¤±æ•—", "error"); }
            };

            const handleDeleteLog = async (ts) => {
                if(!confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) return;
                try {
                    const newLogs = currentClient.logs.filter(l => l.timestamp !== ts);
                    const newLast = newLogs.length ? Math.max(...newLogs.map(l => l.timestamp)) : null;
                    await db.collection('clients').doc(currentClient.id).update({ logs: newLogs, lastContactAt: newLast || firebase.firestore.FieldValue.delete() });
                    setCurrentClient(p => ({ ...p, logs: newLogs, lastContactAt: newLast }));
                    showToast("ç´€éŒ„å·²åˆªé™¤");
                } catch (error) { showToast("åˆªé™¤å¤±æ•—", "error"); }
            };

            const handleDelete = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await db.collection('clients').doc(id).delete(); showToast("å·²åˆªé™¤"); } };
            
            const handleExportCSV = () => {
                const headers = ["å§“å,é›»è©±,ç‹€æ…‹,å€åŸŸ,æ€§åˆ¥,å¹´é½¡,æœˆæ”¶å…¥,è·æ¥­,å©šå§»,ä½å®¶åœ°å€,å…¬å¸åœ°å€,LINE,FB,IG,æ¨è–¦åå–®,ä¿éšªèº«ä»½,ä¿éšªç”¢å“,æˆ¿ç”¢é¡å‹,ç”¨é€”,æˆ¿æ•¸,è»Šä½,å±‹é½¡,æˆ¿ç”¢é ç®—,æœ€å¾Œè¯çµ¡,ä¸‹æ¬¡è·Ÿé€²"];
                const rows = clients.map(c => [
                    c.name, c.phone, c.status, c.region, c.gender, c.age, c.income, c.occupation, c.maritalStatus,
                    c.homeAddress || '', c.companyAddress || '', c.lineId || '', c.facebook || '', c.instagram || '',
                    c.referrals || '',
                    c.insuranceData?.categories ? c.insuranceData.categories.join(';') : (c.insuranceData?.category || ''),
                    c.insuranceData?.products ? c.insuranceData.products.join(';') : '',
                    c.realEstateData?.type || '', c.realEstateData?.usage || '', c.realEstateData?.room || '', c.realEstateData?.parking || '', c.realEstateData?.age || '', c.realEstateData?.budget || '',
                    c.lastContactAt ? new Date(c.lastContactAt).toLocaleDateString() : '',
                    c.nextContactDate ? new Date(c.nextContactDate).toLocaleDateString() : ''
                ].join(','));
                const csvContent = "\uFEFF" + [headers, ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url; link.download = `CRM_Export_${new Date().toISOString().slice(0,10)}.csv`; link.click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (Array.isArray(data) && confirm(`åŒ¯å…¥ ${data.length} ç­†è³‡æ–™ï¼Ÿ`)) {
                            data.forEach(async c => { const { id, ...rest } = c; await db.collection('clients').add({ ...rest, createdAt: c.createdAt || Date.now() }); });
                            showToast("åŒ¯å…¥ä¸­...");
                        }
                    } catch (err) { showToast("æ ¼å¼éŒ¯èª¤", "error"); }
                };
                reader.readAsText(file); e.target.value = null; 
            };

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };

            const handleCategoryChange = (category) => {
                setFormData(prev => {
                    const current = prev.insuranceCategories || [];
                    if (current.includes(category)) return { ...prev, insuranceCategories: current.filter(c => c !== category) };
                    return { ...prev, insuranceCategories: [...current, category] };
                });
            };

            const handleProductChange = (product) => {
                setFormData(prev => {
                    const current = prev.insProducts || [];
                    if (current.includes(product)) return { ...prev, insProducts: current.filter(p => p !== product) };
                    return { ...prev, insProducts: [...current, product] };
                });
            };

            const toggleCard = (id) => setExpandedCardId(expandedCardId === id ? null : id);
            
            const copyToClipboard = (text) => { 
                if(!text) return; 
                navigator.clipboard.writeText(text); 
                showToast("å·²è¤‡è£½ï¼"); 
            };

            const copyCardInfo = (c) => {
                const info = `ã€å®¢æˆ¶è³‡æ–™ã€‘${c.name} (${c.status})\né›»è©±ï¼š${c.phone||'æœªå¡«'}\nå€åŸŸï¼š${c.region||'æœªå¡«'}\néœ€æ±‚ï¼š${c.types.realEstate?'æˆ¿ç”¢ ':''}${c.types.insurance?'ä¿éšª':''}\nå‚™è¨»ï¼š${c.logs && c.logs.length>0 ? c.logs[c.logs.length-1].content : 'ç„¡'}`;
                navigator.clipboard.writeText(info);
                showToast("åç‰‡å·²è¤‡è£½ï¼");
            };

            const copyGreeting = (name) => { navigator.clipboard.writeText(`Hi ${name}ï¼Œå¥½ä¹…ä¸è¦‹ï¼æœ€è¿‘éå¾—å¥½å—ï¼Ÿ\nç¥æ‚¨ç”Ÿæ—¥å¿«æ¨‚ï¼Œå¹³å®‰é †å¿ƒï¼ğŸ‚`); showToast("ç¥ç¦èªå·²è¤‡è£½ï¼"); };
            const openMap = (addr) => { if(addr) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`, '_blank'); };
            const openUrl = (url) => { if(url) window.open(url.startsWith('http') ? url : `https://${url}`, '_blank'); };
            const togglePin = async (e, client) => { e.stopPropagation(); try { await db.collection('clients').doc(client.id).update({ isPinned: !client.isPinned }); showToast(client.isPinned ? "å–æ¶ˆç½®é ‚" : "å·²ç½®é ‚"); } catch(err) { showToast("æ“ä½œå¤±æ•—", "error"); } };

            // Lists
            const uniqueRegions = useMemo(() => Array.from(new Set(clients.map(c => c.region || c.realEstateData?.region).filter(Boolean))), [clients]);
            
            const filtered = useMemo(() => {
                let res = clients.filter(c => {
                    if (quickFilter === 'Birthday') if (!c.birthday || (new Date(c.birthday).getMonth() !== new Date().getMonth())) return false;
                    if (quickFilter === 'Following' && c.status !== 'è·Ÿé€²ä¸­') return false;
                    if (activeTab === 'realEstate' && !c.types.realEstate) return false;
                    if (activeTab === 'insurance' && !c.types.insurance) return false;
                    const term = searchTerm.toLowerCase();
                    if (term && !(c.name.toLowerCase().includes(term) || c.phone?.includes(term) || (c.region||'').includes(term) || (c.tags||[]).join('').includes(term))) return false;
                    if (filterRegion !== 'All' && c.region !== filterRegion) return false;
                    if (filterReType !== 'All' && c.realEstateData?.type !== filterReType) return false;
                    if (filterGender !== 'All' && c.gender !== filterGender) return false;
                    const age = parseInt(c.age || 0);
                    if (filterAge !== 'All') {
                        if (filterAge === '20ä»¥ä¸‹' && (age > 20 || age === 0)) return false;
                        if (filterAge === '20-30' && (age <= 20 || age > 30)) return false;
                        if (filterAge === '30-40' && (age <= 30 || age > 40)) return false;
                        if (filterAge === '40-50' && (age <= 40 || age > 50)) return false;
                        if (filterAge === '50ä»¥ä¸Š' && age <= 50) return false;
                    }
                    return true;
                });
                return res.sort((a, b) => {
                    if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                    return sortBy === 'updated' ? (b.lastContactAt || b.createdAt) - (a.lastContactAt || a.createdAt) : b.createdAt - a.createdAt;
                });
            }, [clients, activeTab, searchTerm, filterRegion, filterGender, filterAge, sortBy, quickFilter, filterReType]);

            const formatDate = (ts) => { if(!ts) return ''; const d = new Date(ts); return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };
            const getRiskLevel = (ts) => { if(!ts) return 'bg-gray-100 text-gray-500'; const d = (Date.now()-ts)/86400000; return d>30 ? 'bg-red-100 text-red-600 font-bold' : (d>14 ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'); };
            const getRiskLabel = (ts) => { if(!ts) return 'æœªè¯ç¹«'; const d = Math.floor((Date.now()-ts)/86400000); return d===0 ? 'ä»Šå¤©' : `${d}å¤©å‰`; };
            const getStatusColor = (s) => ({'æ–°å®¢æˆ¶':'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200','è·Ÿé€²ä¸­':'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200','è€ƒæ…®ä¸­':'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200','å·²æˆäº¤':'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200','å·²çµæ¡ˆ':'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'})[s] || 'bg-gray-100';
            const getInsCatColor = (c) => ({'åˆä½œå¤¥ä¼´':'bg-indigo-100 text-indigo-800 border-indigo-200','å¢å“¡å°è±¡':'bg-pink-100 text-pink-800 border-pink-200','ä¸€èˆ¬å®¢æˆ¶':'bg-emerald-100 text-emerald-800 border-emerald-200'})[c] || 'bg-gray-100';
            const getReTypeColor = (t) => {
                if (t === 'å¤§æ¨“') return 'bg-blue-100 text-blue-800 border-blue-200';
                if (t === 'é€å¤©') return 'bg-orange-100 text-orange-800 border-orange-200';
                if (t === 'å…¬å¯“') return 'bg-green-100 text-green-800 border-green-200';
                return 'bg-gray-100 text-gray-600';
            };
            const getProductColor = (p) => {
                if (p.includes('é†«ç™‚')) return 'bg-red-100 text-red-700';
                if (p.includes('æŠ•è³‡')) return 'bg-blue-100 text-blue-700';
                if (p.includes('å°å¹£')) return 'bg-green-100 text-green-700';
                if (p.includes('ç¾å…ƒ')) return 'bg-teal-100 text-teal-700';
                if (p.includes('åˆ†ç´…')) return 'bg-purple-100 text-purple-700';
                return 'bg-gray-100';
            };
            const getTagColor = (tag) => {
                if (tag.includes('é«˜è³‡ç”¢') || tag.includes('VIP')) return 'bg-yellow-100 text-yellow-700 border-yellow-200';
                if (tag.includes('è½‰ä»‹ç´¹')) return 'bg-purple-100 text-purple-700 border-purple-200';
                return 'bg-gray-100 text-gray-600 border-gray-200 dark:bg-dark-700 dark:text-gray-400 dark:border-dark-600';
            };
            const getStatusPct = (s) => ({'æ–°å®¢æˆ¶':'20%','è·Ÿé€²ä¸­':'40%','è€ƒæ…®ä¸­':'60%','å·²æˆäº¤':'100%','å·²çµæ¡ˆ':'100%'})[s] || '0%';
            const getStatusPctColor = (s) => ({'æ–°å®¢æˆ¶':'bg-blue-500','è·Ÿé€²ä¸­':'bg-yellow-500','è€ƒæ…®ä¸­':'bg-purple-500','å·²æˆäº¤':'bg-green-500','å·²çµæ¡ˆ':'bg-gray-400'})[s] || 'bg-gray-200';

            const TabBtn = ({ id, label, icon: Icon, color }) => (
                <button onClick={() => setActiveTab(id)} className={`flex items-center px-4 py-2 rounded-lg font-medium transition-colors mx-1 whitespace-nowrap ${activeTab === id ? `${color} text-white shadow` : 'bg-white text-gray-600 hover:bg-gray-100'}`}>
                    <span className="mr-2"><Icon/></span>{label}
                    <span className="ml-2 text-xs bg-white/20 px-2 py-0.5 rounded-full">{id === 'all' ? clients.length : clients.filter(c => c.types[id]).length}</span>
                </button>
            );

            return (
                <div className="min-h-screen p-3 sm:p-8 max-w-7xl mx-auto pb-24 transition-colors duration-300">
                    {/* Header */}
                    <div className="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-3xl font-bold flex items-center gap-2 text-indigo-600 dark:text-indigo-400">
                                <Icons.Cloud/> æ™ºèƒ½æˆ°æƒ…å®¤ <span className="text-xs bg-gray-800 text-white px-2 py-1 rounded-full">V23</span>
                            </h1>
                            <p className="text-gray-500 dark:text-gray-400 mt-1 text-sm">æˆ¿ç”¢ x ä¿éšª â€¢ å¤šé‡èº«ä»½</p>
                        </div>
                        <div className="flex gap-2 w-full sm:w-auto items-center">
                            <button onClick={()=>setDarkMode(!darkMode)} className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-yellow-400 mr-2">{darkMode ? <Icons.Sun/> : <Icons.Moon/>}</button>
                            <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" accept=".json" />
                            <button onClick={() => fileInputRef.current.click()} className="px-3 py-2 bg-white text-gray-600 border rounded-lg hover:bg-gray-50 shadow-sm flex items-center text-sm font-medium"><span className="mr-1"><Icons.Upload/></span>åŒ¯å…¥</button>
                            <button onClick={handleExportCSV} className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-sm flex items-center text-sm font-medium"><span className="mr-1"><Icons.Excel/></span>Excel</button>
                        </div>
                    </div>

                    {/* Dashboard + Memo Widget */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div onClick={() => setQuickFilter('All')} className={`cursor-pointer p-4 rounded-xl shadow-sm border transition-all ${quickFilter==='All' ? 'border-indigo-500 ring-2 ring-indigo-200 bg-indigo-50 dark:bg-indigo-900/30' : 'bg-white dark:bg-dark-800 border-gray-100 dark:border-dark-700'} h-40 flex flex-col justify-center`}>
                            <span className="text-gray-500 dark:text-gray-400 text-xs font-bold uppercase block mb-1">ç¸½å®¢æˆ¶æ•¸</span>
                            <span className="text-4xl font-extrabold text-gray-800 dark:text-white">{stats.total}</span>
                        </div>
                        
                        {/* Pipeline Value Widget */}
                        <div className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 p-4 rounded-xl shadow-sm border border-emerald-100 dark:border-emerald-800 h-40 flex flex-col justify-center relative overflow-hidden">
                            <div className="absolute top-2 right-2 text-emerald-200 dark:text-emerald-800 opacity-50"><Icons.ChartBar/></div>
                            <span className="text-emerald-700 dark:text-emerald-400 text-xs font-bold uppercase block mb-1">æ½›åœ¨æ¡ˆé‡ (è·Ÿé€²ä¸­)</span>
                            <span className="text-3xl font-extrabold text-emerald-600 dark:text-emerald-300">{stats.pipelineValue.toLocaleString()} <span className="text-sm font-normal">è¬</span></span>
                            <div className="w-full bg-emerald-200 h-1 mt-3 rounded-full"></div>
                        </div>

                        <div onClick={() => setQuickFilter('Following')} className={`cursor-pointer p-4 rounded-xl shadow-sm border transition-all ${quickFilter==='Following' ? 'border-yellow-500 ring-2 ring-yellow-200 bg-yellow-50 dark:bg-yellow-900/30' : 'bg-white dark:bg-dark-800 border-gray-100 dark:border-dark-700'} h-40 flex flex-col justify-center`}>
                            <span className="text-yellow-600 text-xs font-bold uppercase block mb-1">è·Ÿé€²ä¸­</span>
                            <span className="text-4xl font-extrabold text-yellow-600">{stats.following}</span>
                        </div>
                        
                        {/* Memo Widget */}
                        <MemoWidget db={db} />
                    </div>

                    {/* Filter & Sort */}
                    <div className="bg-white dark:bg-dark-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-dark-700 mb-6 space-y-4">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-3">
                            <div className="flex w-full md:w-auto overflow-x-auto pb-1 md:pb-0 gap-1">
                                <TabBtn id="all" label="å…¨éƒ¨" icon={Icons.User} color="bg-gray-800" />
                                <TabBtn id="realEstate" label="æˆ¿ç”¢" icon={Icons.Home} color="bg-blue-600" />
                                <TabBtn id="insurance" label="ä¿éšª" icon={Icons.Shield} color="bg-emerald-600" />
                            </div>
                            <div className="relative w-full md:w-72">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Search /></div>
                                <input type="text" placeholder="æœå°‹..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="block w-full pl-10 pr-3 py-2 rounded-lg border border-gray-200 dark:border-dark-700 focus:ring-2 focus:ring-indigo-500 bg-gray-50 dark:bg-dark-900 outline-none transition-colors" />
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center gap-2 pt-3 border-t border-gray-100 dark:border-dark-700">
                            <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className="bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 text-gray-700 dark:text-gray-300 text-xs rounded-lg p-2"><option value="updated">â° æœ€è¿‘è¯çµ¡</option><option value="created">ğŸ†• å»ºç«‹æ—¥æœŸ</option></select>
                            <div className="h-4 w-px bg-gray-300 dark:bg-dark-700 mx-1"></div>
                            <select value={filterReType} onChange={e=>setFilterReType(e.target.value)} className="bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 text-gray-700 dark:text-gray-300 text-xs rounded-lg p-2"><option value="All">æ‰€æœ‰æˆ¿å‹</option><option value="å¤§æ¨“">ğŸ¢ å¤§æ¨“</option><option value="é€å¤©">ğŸ  é€å¤©</option><option value="å…¬å¯“">ğŸšï¸ å…¬å¯“</option><option value="è¯å»ˆ">ğŸ™ï¸ è¯å»ˆ</option><option value="åº—é¢">ğŸª åº—é¢</option><option value="åœŸåœ°">ğŸï¸ åœŸåœ°</option></select>
                            <select value={filterRegion} onChange={e=>setFilterRegion(e.target.value)} className="bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 text-gray-700 dark:text-gray-300 text-xs rounded-lg p-2"><option value="All">æ‰€æœ‰å€åŸŸ</option>{uniqueRegions.map(r => <option key={r} value={r}>{r}</option>)}</select>
                            <select value={filterGender} onChange={e=>setFilterGender(e.target.value)} className="bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 text-gray-700 dark:text-gray-300 text-xs rounded-lg p-2"><option value="All">æ‰€æœ‰æ€§åˆ¥</option><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
                            {(filterRegion!=='All'||filterGender!=='All'||searchTerm||quickFilter!=='All'||filterReType!=='All') && <button onClick={()=>{setFilterRegion('All');setFilterGender('All');setSearchTerm('');setQuickFilter('All');setFilterReType('All');}} className="text-xs text-red-500 hover:underline ml-auto">æ¸…é™¤</button>}
                        </div>
                    </div>

                    {/* Client List */}
                    {loading ? <div className="text-center py-20 text-gray-500 animate-pulse">è®€å–ä¸­...</div> : filtered.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            {filtered.map(c => (
                                <div key={c.id} className={`bg-white dark:bg-dark-800 rounded-xl shadow-sm border-l-4 ${c.types.realEstate && c.types.insurance ? "border-purple-400" : (c.types.realEstate ? "border-blue-400" : "border-emerald-400")} p-5 hover:shadow-lg transition-all relative group flex flex-col`}>
                                    
                                    {/* Status Bar */}
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gray-100 dark:bg-gray-700 rounded-t-xl overflow-hidden">
                                        <div className={`h-full ${getStatusPctColor(c.status)}`} style={{width: getStatusPct(c.status)}}></div>
                                    </div>

                                    {/* Lead Score Badge */}
                                    <div className="absolute top-4 right-14 flex items-center bg-gray-50 dark:bg-dark-700 px-2 py-1 rounded-full shadow-sm border border-gray-100 dark:border-dark-600" title={`ç†±åº¦: ${calculateLeadScore(c)}åˆ†`}>
                                        <Icons.Fire/>
                                        <span className="text-xs font-bold ml-1 text-gray-600 dark:text-gray-300">{calculateLeadScore(c)}</span>
                                    </div>

                                    <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={(e) => togglePin(e, c)} className={`${c.isPinned ? 'text-orange-500' : 'text-gray-300'} hover:text-orange-600`} title="ç½®é ‚">{c.isPinned ? <Icons.Pin/> : <Icons.PinOff/>}</button>
                                        <button onClick={() => openEditModal(c)} className="text-gray-400 hover:text-indigo-600 p-1"><Icons.Edit/></button>
                                        <button onClick={() => handleDelete(c.id)} className="text-gray-400 hover:text-red-500 p-1"><Icons.Trash/></button>
                                    </div>
                                    
                                    {/* Header Info */}
                                    <div className="flex items-start mb-3 mt-2">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white mr-3 shadow-md ${c.gender === 'å¥³' ? 'bg-pink-400' : 'bg-blue-500'}`}><Icons.User/></div>
                                        <div>
                                            <div className="font-bold text-lg text-gray-900 dark:text-gray-100 flex items-center gap-2">
                                                {c.name}
                                                <span className={`text-[10px] px-2 py-0.5 rounded-full ${getStatusColor(c.status || 'æ–°å®¢æˆ¶')}`}>{c.status || 'æ–°å®¢æˆ¶'}</span>
                                                <button onClick={() => copyCardInfo(c)} className="text-gray-300 hover:text-indigo-500" title="è¤‡è£½åç‰‡"><Icons.Card/></button>
                                            </div>
                                            <div className="flex items-center gap-2 mt-1">
                                                {c.phone ? (
                                                    <>
                                                        <a href={`tel:${c.phone}`} className="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-indigo-600">{c.phone}</a>
                                                        <button onClick={() => copyToClipboard(c.phone)} className="text-gray-300 hover:text-indigo-500" title="è¤‡è£½é›»è©±"><Icons.Copy/></button>
                                                    </>
                                                ) : (
                                                    <span className="text-xs text-gray-400 italic">æœªå¡«å¯«é›»è©±</span>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Address Display */}
                                    <div className="mt-3 space-y-1">
                                        {c.homeAddress && (
                                            <div onClick={(e) => { e.stopPropagation(); openMap(c.homeAddress); }} className="flex items-start text-xs text-gray-600 dark:text-gray-300 cursor-pointer hover:text-indigo-600">
                                                <span className="mt-0.5 mr-1.5 flex-shrink-0"><Icons.Home /></span>
                                                <span className="line-clamp-1">{c.homeAddress}</span>
                                            </div>
                                        )}
                                        {c.companyAddress && (
                                            <div onClick={(e) => { e.stopPropagation(); openMap(c.companyAddress); }} className="flex items-start text-xs text-gray-600 dark:text-gray-300 cursor-pointer hover:text-blue-600">
                                                <span className="mt-0.5 mr-1.5 flex-shrink-0"><Icons.Building /></span>
                                                <span className="line-clamp-1">{c.companyAddress}</span>
                                            </div>
                                        )}
                                    </div>

                                    {/* Compact View Info */}
                                    <div className="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400 mb-2 mt-2">
                                        <div className="flex items-center gap-2">
                                            <span>{c.nextContactDate ? `âš ï¸ ${formatDate(c.nextContactDate).split(' ')[0]} å¾…è¯ç¹«` : (c.lastContactAt ? `ğŸ•’ ${timeAgo(c.lastContactAt)}` : 'å°šæœªè¯ç¹«')}</span>
                                            {c.nextContactDate && <button onClick={() => addToGoogleCalendar(c)} className="text-blue-500 hover:text-blue-700" title="åŠ å…¥è¡Œäº‹æ›†"><Icons.GoogleCal/></button>}
                                        </div>
                                        <button onClick={() => toggleCard(c.id)} className="text-indigo-500 hover:bg-indigo-50 rounded p-1"><Icons.ChevronDown/></button>
                                    </div>

                                    {/* Expanded Details */}
                                    <div className={`space-y-3 overflow-hidden transition-all duration-300 ${expandedCardId === c.id ? 'max-h-[800px] opacity-100' : 'max-h-0 opacity-0'}`}>
                                        
                                        {/* Social Icons */}
                                        <div className="flex gap-3 border-b dark:border-dark-700 pb-2 pt-1">
                                            {c.lineId && <button onClick={()=>copyToClipboard(c.lineId)} className="text-green-500 hover:scale-110" title={`LINE: ${c.lineId}`}><Icons.Line/></button>}
                                            {c.facebook && <button onClick={()=>openUrl(c.facebook)} className="text-blue-600 hover:scale-110" title="Facebook"><Icons.Facebook/></button>}
                                            {c.instagram && <button onClick={()=>openUrl(c.instagram)} className="text-pink-500 hover:scale-110" title="Instagram"><Icons.Instagram/></button>}
                                        </div>

                                        <div className="grid grid-cols-2 gap-2 text-xs text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-dark-900 p-2.5 rounded-lg border border-gray-100 dark:border-dark-700">
                                            <div className="flex items-center"><span className="text-gray-400 mr-1.5"><Icons.Briefcase/></span>{c.occupation || "-"}</div>
                                            <div className="flex items-center"><span className="text-gray-400 mr-1.5"><Icons.Money/></span>{c.income ? c.income+"è¬/æœˆ" : "-"}</div>
                                            <div className="flex items-center col-span-2 justify-between mt-1">
                                                <div className="flex items-center"><span className="text-gray-400 mr-1.5"><Icons.Heart/></span>{c.maritalStatus || "-"}</div>
                                                {c.birthday && (
                                                    <div className="flex flex-col items-end">
                                                        <div className="flex items-center text-pink-500 font-medium cursor-pointer hover:bg-pink-100 px-1 rounded transition-colors" onClick={()=>copyGreeting(c.name)} title="è¤‡è£½ç¥ç¦èª">
                                                            <span className="mr-1"><Icons.Cake/></span>{c.birthday.slice(5)} ({getZodiac(c.birthday)})
                                                        </div>
                                                        <div className="text-[10px] text-gray-400 mt-0.5">{getAge(c.birthday)}æ­² Â· é‚„æœ‰ {getDaysUntilBirthday(c.birthday)} å¤©</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="flex flex-wrap gap-1.5">
                                            {c.region && <button onClick={()=>openMap(c.region)} className="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 dark:bg-dark-700 dark:text-indigo-300 dark:border-dark-600 hover:bg-indigo-100 transition-colors flex items-center">ğŸ“ {c.region}</button>}
                                            {c.tags && c.tags.map((t, i) => <button key={i} onClick={()=>setSearchTerm(t)} className={`text-xs px-2 py-1 rounded border hover:opacity-80 transition-colors ${getTagColor(t)}`}>#{t}</button>)}
                                        </div>

                                        {/* æ¨è–¦åå–® */}
                                        {c.referrals && (
                                            <div className="mt-2 p-2 bg-amber-50 dark:bg-amber-900/30 rounded border border-amber-100 dark:border-amber-800 text-xs text-amber-800 dark:text-amber-200">
                                                <div className="flex items-center font-bold mb-1"><Icons.Users/><span className="ml-1">æ¨è–¦åå–®</span></div>
                                                <div className="whitespace-pre-wrap">{c.referrals}</div>
                                            </div>
                                        )}

                                        <div className="space-y-2">
                                            {c.types.realEstate && (
                                                <div className="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-xs text-blue-900 dark:text-blue-200 border border-blue-100 dark:border-blue-900/30">
                                                    <div className="flex justify-between items-center mb-2 border-b border-blue-200 pb-1">
                                                        <div className="flex items-center font-bold"><Icons.Home/><span className="ml-1">æˆ¿ç”¢</span>
                                                        {c.realEstateData?.type && <span className={`ml-2 text-[10px] px-1.5 rounded border ${getReTypeColor(c.realEstateData.type)}`}>{c.realEstateData.type}</span>}
                                                        {c.realEstateData?.usage && <span className="ml-1 text-[10px] px-1.5 bg-blue-100 text-blue-800 rounded">{c.realEstateData.usage}</span>}
                                                        </div>
                                                        <span className="font-bold">{c.realEstateData?.budget}è¬</span>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-1 text-[11px] mb-1">
                                                        {c.realEstateData?.room && <div className="flex items-center"><span className="text-blue-400 mr-1"><Icons.Bed/></span>{c.realEstateData.room}</div>}
                                                        {c.realEstateData?.parking && <div className="flex items-center"><span className="text-blue-400 mr-1"><Icons.Car/></span>{c.realEstateData.parking}</div>}
                                                        {c.realEstateData?.age && <div className="flex items-center col-span-2"><span className="text-blue-400 mr-1">å±‹é½¡</span>{c.realEstateData.age}</div>}
                                                    </div>
                                                    <div className="opacity-80 truncate border-t border-blue-200 pt-1 mt-1">{c.realEstateData?.requirements.join(" Â· ")}</div>
                                                </div>
                                            )}
                                            {c.types.insurance && <div className="bg-emerald-50 dark:bg-emerald-900/20 p-2.5 rounded-lg text-xs text-emerald-900 dark:text-emerald-200 border border-emerald-100 dark:border-emerald-900/30">
                                                <div className="flex items-center font-bold mb-1"><Icons.Shield/><span className="ml-1">ä¿éšª</span>
                                                {/* Multi-category Badges */}
                                                {c.insuranceData?.categories && c.insuranceData.categories.length > 0 ? (
                                                    c.insuranceData.categories.map(cat => (
                                                        <span key={cat} className={`ml-1 text-[10px] px-1.5 rounded border ${getInsCatColor(cat)}`}>{cat}</span>
                                                    ))
                                                ) : (
                                                    c.insuranceData?.category && <span className={`ml-2 text-[10px] px-1.5 rounded border ${getInsCatColor(c.insuranceData.category)}`}>{c.insuranceData.category}</span>
                                                )}
                                                <span className="ml-auto opacity-75">{c.insuranceData?.budget}è¬/å¹´</span></div>
                                                
                                                {/* Insurance Products Tags */}
                                                {c.insuranceData?.products && c.insuranceData.products.length > 0 && (
                                                    <div className="flex flex-wrap gap-1 mb-1 mt-1">
                                                        {c.insuranceData.products.map(p => (
                                                            <span key={p} className={`text-[10px] px-1.5 py-0.5 rounded ${getProductColor(p)}`}>{p}</span>
                                                        ))}
                                                    </div>
                                                )}
                                                
                                                <div className="opacity-80 truncate">{c.insuranceData?.needs.join(" Â· ")}</div>
                                            </div>}
                                        </div>
                                    </div>
                                    
                                    <div className="border-t dark:border-dark-700 pt-3 mt-auto">
                                        <div className="text-xs text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-dark-900 p-2.5 rounded-lg min-h-[42px] max-h-[60px] overflow-hidden border border-gray-100 dark:border-dark-700 mb-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-dark-800" onClick={() => openLogModal(c)}>
                                            {c.logs && c.logs.length > 0 ? <div><span className="text-indigo-400 font-mono mr-1">{formatDate(c.logs[c.logs.length-1].timestamp).split(' ')[0]}</span> {c.logs[c.logs.length-1].content}</div> : <span className="opacity-50 italic">é»æ“Šæ–°å¢ç´€éŒ„...</span>}
                                        </div>
                                        <button onClick={() => openLogModal(c)} className="w-full text-xs text-white bg-indigo-600 hover:bg-indigo-700 flex justify-center items-center font-medium px-3 py-2 rounded-lg shadow-sm"><span className="mr-1"><Icons.Note/></span> æ–°å¢ç´€éŒ„ / è·Ÿé€²</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-20 bg-white dark:bg-dark-800 rounded-xl border-2 border-dashed border-gray-200 dark:border-dark-700">
                            <p className="text-gray-500 dark:text-gray-400 text-lg">ç„¡ç¬¦åˆè³‡æ–™</p>
                        </div>
                    )}

                    {/* Floating Action Button (FAB) */}
                    <button onClick={openAddModal} className="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center hover:bg-indigo-700 hover:scale-110 transition-transform z-40">
                        <Icons.Plus/>
                    </button>

                    {/* Modals */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                            <div className="bg-white dark:bg-dark-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                                <div className="p-5 border-b dark:border-dark-700 flex justify-between items-center sticky top-0 bg-white dark:bg-dark-800 z-10">
                                    <h3 className="text-xl font-bold dark:text-white">{isEditMode ? 'ç·¨è¼¯' : 'æ–°å¢'}</h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-gray-400"><Icons.Close/></button>
                                </div>
                                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="text" name="name" value={formData.name} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-900 rounded p-2" placeholder="å§“å *" required />
                                        <input type="text" name="phone" value={formData.phone} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-900 rounded p-2" placeholder="é›»è©±" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <select name="status" value={formData.status} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-900 rounded p-2"><option value="æ–°å®¢æˆ¶">âœ¨ æ–°å®¢æˆ¶</option><option value="è·Ÿé€²ä¸­">ğŸ”„ è·Ÿé€²ä¸­</option><option value="è€ƒæ…®ä¸­">ğŸ¤” è€ƒæ…®ä¸­</option><option value="å·²æˆäº¤">ğŸ‰ å·²æˆäº¤</option><option value="å·²çµæ¡ˆ">ğŸ“ å·²çµæ¡ˆ</option></select>
                                        <input type="text" name="region" value={formData.region} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-900 rounded p-2" placeholder="å€åŸŸ" />
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <select name="gender" value={formData.gender} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-900 rounded p-2"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
                                        <input type="number" name="age" value={formData.age} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-900 rounded p-2" placeholder="å¹´é½¡" />
                                        <select name="maritalStatus" value={formData.maritalStatus} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-900 rounded p-2"><option value="æœªå©š">æœªå©š</option><option value="å·²å©š">å·²å©š</option><option value="é›¢å©š">é›¢å©š</option><option value="å–ªå¶">å–ªå¶</option><option value="å…¶ä»–">å…¶ä»–</option></select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="text" name="occupation" value={formData.occupation} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-900 rounded p-2" placeholder="è·æ¥­" />
                                        <input type="number" name="income" value={formData.income} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-900 rounded p-2" placeholder="æœˆæ”¶(è¬)" />
                                    </div>
                                    <input type="date" name="birthday" value={formData.birthday} onChange={handleChange} className="w-full border dark:border-dark-700 dark:bg-dark-900 rounded p-2" />
                                    
                                    {/* Contact & Address Section */}
                                    <div className="space-y-2 bg-gray-50 dark:bg-dark-900 p-3 rounded border dark:border-dark-700">
                                        <div className="grid grid-cols-2 gap-2">
                                            <input type="text" name="homeAddress" value={formData.homeAddress} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-800 rounded p-2 text-sm" placeholder="ä½å®¶åœ°å€" />
                                            <input type="text" name="companyAddress" value={formData.companyAddress} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-800 rounded p-2 text-sm" placeholder="å…¬å¸åœ°å€" />
                                        </div>
                                        <div className="grid grid-cols-3 gap-2">
                                            <input type="text" name="lineId" value={formData.lineId} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-800 rounded p-2 text-sm" placeholder="LINE ID" />
                                            <input type="text" name="facebook" value={formData.facebook} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-800 rounded p-2 text-sm" placeholder="FBé€£çµ" />
                                            <input type="text" name="instagram" value={formData.instagram} onChange={handleChange} className="border dark:border-dark-700 dark:bg-dark-800 rounded p-2 text-sm" placeholder="IGé€£çµ" />
                                        </div>
                                    </div>

                                    {/* Referral Section */}
                                    <div className="col-span-2">
                                        <label className="text-xs font-bold text-gray-500 mb-1 block">æ¨è–¦åå–® (ä»‹ç´¹äºº/è¢«ä»‹ç´¹äºº)</label>
                                        <textarea name="referrals" value={formData.referrals} onChange={handleChange} className="w-full border dark:border-dark-700 dark:bg-dark-900 rounded p-2 text-sm h-20" placeholder="ä¾‹å¦‚ï¼šä»‹ç´¹äº†ç‹å°æ˜ã€é™³å¤§è¯..." />
                                    </div>

                                    <input type="text" name="tags" value={formData.tags} onChange={handleChange} className="w-full border dark:border-dark-700 dark:bg-dark-900 rounded p-2" placeholder="æ¨™ç±¤ (ç©ºç™½åˆ†éš”)" />
                                    
                                    <div className="pt-2 space-y-2">
                                        <div className={`border rounded p-2 ${formData.isRealEstate?'border-blue-400 bg-blue-50 dark:bg-blue-900/30':''}`}><label className="flex items-center"><input type="checkbox" name="isRealEstate" checked={formData.isRealEstate} onChange={handleChange} className="mr-2" /><span className="font-bold text-blue-700 dark:text-blue-400">æˆ¿ç”¢éœ€æ±‚</span></label>{formData.isRealEstate && <div className="mt-2 space-y-2"><div className="grid grid-cols-2 gap-2"><select name="reType" value={formData.reType} onChange={handleChange} className="w-full border rounded p-1 text-sm dark:bg-dark-900"><option value="å¤§æ¨“">ğŸ¢ é›»æ¢¯å¤§æ¨“</option><option value="é€å¤©">ğŸ  é€å¤©å</option><option value="å…¬å¯“">ğŸšï¸ å…¬å¯“</option><option value="è¯å»ˆ">ğŸ™ï¸ è¯å»ˆ</option><option value="åº—é¢">ğŸª åº—é¢</option><option value="åœŸåœ°">ğŸï¸ åœŸåœ°</option></select><select name="reUsage" value={formData.reUsage} onChange={handleChange} className="w-full border rounded p-1 text-sm dark:bg-dark-900"><option value="è‡ªä½">è‡ªä½</option><option value="æŠ•è³‡">æŠ•è³‡</option><option value="æ”¶ç§Ÿ">æ”¶ç§Ÿ</option><option value="ç½®ç”¢">ç½®ç”¢</option></select></div><div className="grid grid-cols-3 gap-2"><input type="text" name="reRoom" value={formData.reRoom} onChange={handleChange} className="w-full border rounded p-1 text-sm dark:bg-dark-900" placeholder="æˆ¿æ•¸ (å¦‚: 3æˆ¿)" /><select name="reParking" value={formData.reParking} onChange={handleChange} className="w-full border rounded p-1 text-sm dark:bg-dark-900"><option value="éœ€è¦">éœ€è¦è»Šä½</option><option value="å¹³é¢">å¹³é¢è»Šä½</option><option value="æ©Ÿæ¢°">æ©Ÿæ¢°è»Šä½</option><option value="ä¸æ‹˜">ä¸æ‹˜</option></select><select name="reAge" value={formData.reAge} onChange={handleChange} className="w-full border rounded p-1 text-sm dark:bg-dark-900"><option value="">å±‹é½¡ä¸æ‹˜</option><option value="æ–°æˆå±‹">æ–°æˆå±‹</option><option value="10å¹´å…§">10å¹´å…§</option><option value="20å¹´å…§">20å¹´å…§</option><option value="30å¹´ä»¥ä¸Š">30å¹´ä»¥ä¸Š</option></select></div><div className="flex gap-2"><input type="number" name="reBudget" value={formData.reBudget} onChange={handleChange} className="w-1/2 border rounded p-1 text-sm dark:bg-dark-900" placeholder="é ç®—(è¬)" /><input type="text" name="reRequirements" value={formData.reRequirements} onChange={handleChange} className="w-1/2 border rounded p-1 text-sm dark:bg-dark-900" placeholder="éœ€æ±‚" /></div></div>}</div>
                                        
                                        <div className={`border rounded p-2 ${formData.isInsurance?'border-emerald-400 bg-emerald-50 dark:bg-emerald-900/30':''}`}><label className="flex items-center"><input type="checkbox" name="isInsurance" checked={formData.isInsurance} onChange={handleChange} className="mr-2" /><span className="font-bold text-emerald-700 dark:text-emerald-400">ä¿éšªéœ€æ±‚</span></label>
                                        {formData.isInsurance && <div className="mt-2 space-y-2">
                                            {/* Multi-Select for Insurance Category */}
                                            <div className="flex flex-wrap gap-2 mb-2">
                                                {['ä¸€èˆ¬å®¢æˆ¶', 'å¢å“¡å°è±¡', 'åˆä½œå¤¥ä¼´'].map(cat => (
                                                    <label key={cat} className={`flex items-center text-xs px-2 py-1 rounded border cursor-pointer select-none transition-colors ${formData.insuranceCategories.includes(cat) ? 'bg-indigo-100 border-indigo-300 text-indigo-800' : 'bg-gray-50 dark:bg-dark-800 border-gray-300 dark:border-dark-600'}`}>
                                                        <input type="checkbox" className="hidden" checked={formData.insuranceCategories.includes(cat)} onChange={() => handleCategoryChange(cat)} />
                                                        {formData.insuranceCategories.includes(cat) && <span className="mr-1">âœ“</span>}{cat}
                                                    </label>
                                                ))}
                                            </div>
                                            
                                            {/* Product Selection only for 'ä¸€èˆ¬å®¢æˆ¶' */}
                                            {formData.insuranceCategories.includes('ä¸€èˆ¬å®¢æˆ¶') && (
                                                <div className="flex flex-wrap gap-2 mb-2 p-2 bg-emerald-50 dark:bg-emerald-900/20 rounded border border-emerald-100 dark:border-emerald-900/30">
                                                    {['é†«ç™‚éšª', 'æŠ•è³‡å‹', 'å°å¹£å„²è“„', 'ç¾å…ƒå„²è“„', 'åˆ†ç´…ä¿å–®'].map(prod => (
                                                        <label key={prod} className={`flex items-center text-xs px-2 py-1 rounded border cursor-pointer select-none ${formData.insProducts?.includes(prod) ? 'bg-emerald-100 border-emerald-300 text-emerald-800' : 'bg-white dark:bg-dark-800 border-gray-300 dark:border-dark-600'}`}>
                                                            <input type="checkbox" className="hidden" checked={formData.insProducts?.includes(prod)} onChange={() => handleProductChange(prod)} />
                                                            {prod}
                                                        </label>
                                                    ))}
                                                </div>
                                            )}

                                            <div className="flex gap-2"><input type="number" name="insBudget" value={formData.insBudget} onChange={handleChange} className="w-1/2 border rounded p-1 text-sm dark:bg-dark-900" placeholder="é ç®—(è¬/å¹´)" /><input type="text" name="insNeeds" value={formData.insNeeds} onChange={handleChange} className="w-1/2 border rounded p-1 text-sm dark:bg-dark-900" placeholder="å…¶ä»–éœ€æ±‚" /></div>
                                        </div>}</div>
                                    </div>
                                    <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700">å„²å­˜</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Log Modal (Same as V11) */}
                    {isLogModalOpen && currentClient && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                            <div className="bg-white dark:bg-dark-800 rounded-xl shadow-2xl w-full max-w-md h-[85vh] flex flex-col">
                                <div className="p-4 border-b dark:border-dark-700 flex justify-between items-center bg-gray-50 dark:bg-dark-900 rounded-t-xl">
                                    <div><h3 className="text-lg font-bold text-gray-800 dark:text-white">{currentClient.name} <span className="text-sm font-normal text-gray-500">ç´€éŒ„</span></h3></div>
                                    <button onClick={() => setIsLogModalOpen(false)} className="text-gray-400"><Icons.Close/></button>
                                </div>
                                <div className="flex-grow p-5 overflow-y-auto bg-white dark:bg-dark-800">
                                    {currentClient.logs && currentClient.logs.length > 0 ? [...currentClient.logs].sort((a,b) => b.timestamp - a.timestamp).map((log, index) => (
                                        <div key={log.timestamp} className={`timeline-item ${index === 0 ? 'latest' : ''} mb-6`}><div className="timeline-dot"></div><div className="flex justify-between items-start mb-1"><span className="text-xs font-bold text-gray-500 flex items-center bg-gray-100 dark:bg-dark-700 dark:text-gray-300 px-2 py-0.5 rounded"><span className="mr-1 text-gray-400"><Icons.Calendar/></span>{formatDate(log.timestamp)}</span><div className="flex gap-2"><button onClick={() => {setEditingLogTimestamp(log.timestamp);setTempLogContent(log.content);setTempLogDate(getLocalISOString(log.timestamp));}} className="text-xs text-indigo-500 hover:underline">ç·¨è¼¯</button><button onClick={() => handleDeleteLog(log.timestamp)} className="text-xs text-red-400 hover:underline">åˆªé™¤</button></div></div>{editingLogTimestamp === log.timestamp ? <div className="mt-2 bg-indigo-50 dark:bg-indigo-900/30 p-3 rounded-lg border border-indigo-100 dark:border-indigo-800"><input type="datetime-local" value={tempLogDate} onChange={(e) => setTempLogDate(e.target.value)} className="w-full text-xs border rounded px-2 py-1 mb-2 dark:bg-dark-700 dark:border-dark-600 dark:text-white" /><textarea value={tempLogContent} onChange={(e) => setTempLogContent(e.target.value)} className="w-full border p-2 rounded text-sm mb-2 dark:bg-dark-700 dark:border-dark-600 dark:text-white" rows="3" /><div className="flex justify-end gap-2"><button onClick={() => setEditingLogTimestamp(null)} className="text-xs text-gray-500 px-3 py-1.5 rounded border bg-white dark:bg-dark-700 dark:text-white">å–æ¶ˆ</button><button onClick={saveEditLog} className="text-xs text-white bg-indigo-600 px-3 py-1.5 rounded hover:bg-indigo-700 flex items-center shadow-sm"><span className="mr-1"><Icons.Check/></span>å„²å­˜</button></div></div> : <div className="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-dark-700 p-3 rounded-lg text-sm shadow-sm border border-gray-200 dark:border-dark-600 whitespace-pre-wrap leading-relaxed">{log.content}</div>}</div>
                                    )) : <div className="text-center py-20 text-gray-400">ç„¡ç´€éŒ„</div>}
                                </div>
                                <div className="p-4 border-t dark:border-dark-700 bg-gray-50 dark:bg-dark-900 rounded-b-xl shadow-lg">
                                    <form onSubmit={handleAddLog} className="flex flex-col gap-2">
                                        <div className="flex justify-between items-center px-1">
                                            <label className="text-xs font-bold text-gray-500">ç´€éŒ„ / ä¸‹ä¸€æ­¥</label>
                                            <div className="flex gap-2">
                                                <input type="datetime-local" value={newLogDate} onChange={(e) => setNewLogDate(e.target.value)} className="text-[10px] border rounded px-1 dark:bg-dark-800 dark:text-white" title="ç´€éŒ„æ™‚é–“" />
                                            </div>
                                        </div>
                                        <input type="text" value={newLogContent} onChange={(e) => setNewLogContent(e.target.value)} placeholder="è¼¸å…¥å…§å®¹..." className="w-full border rounded-xl py-3 px-4 focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm dark:bg-dark-800 dark:border-dark-600 dark:text-white" />
                                        <div className="flex items-center gap-2 mt-1">
                                            <span className="text-xs text-gray-500 whitespace-nowrap">ä¸‹æ¬¡è¯ç¹«ï¼š</span>
                                            <input type="datetime-local" value={nextContactDate} onChange={(e) => setNextContactDate(e.target.value)} className="w-full text-xs border rounded px-2 py-1 dark:bg-dark-800 dark:text-white" />
                                            <button type="submit" disabled={!newLogContent.trim()} className={`p-2 rounded-lg transition-all ${newLogContent.trim() ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-300 text-gray-500'}`}><Icons.Send/></button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Toast */}
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

